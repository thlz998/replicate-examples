#!/usr/bin/env python3
import sys
from huggingface_hub import login
import diffusers
import torch

sys.path.append(".")

from predict import CACHE_DIR

login(token="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")
qrPatternControlnet = diffusers.ControlNetModel.from_pretrained(
    "Nacholmo/controlnet-qr-pattern",
    torch_dtype=torch.float16,
    cache_dir=CACHE_DIR
)
cannyControlnet = diffusers.ControlNetModel.from_pretrained(
    "lllyasviel/sd-controlnet-canny",
    torch_dtype=torch.float16,
    cache_dir=CACHE_DIR
)

pipe = diffusers.StableDiffusionControlNetImg2ImgPipeline.from_pretrained(
    "gsdf/Counterfeit-V2.5",
    controlnet=[qrPatternControlnet, cannyControlnet],
    safety_checker=None,
    torch_dtype=torch.float16,
    cache_dir=CACHE_DIR,
).to("cuda")
pipe.unet.load_attn_procs("sayakpaul/sd-model-finetuned-lora-t4", cache_dir=CACHE_DIR)
pipe.scheduler = diffusers.DPMSolverMultistepScheduler.from_config(
    pipe.scheduler.config, use_karras=True, algorithm_type="sde-dpmsolver++", cache_dir=CACHE_DIR
)